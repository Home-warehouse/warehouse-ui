<h1 class="is-size-2 my-6">Dashboard</h1>

<!-- Elements -->
<div class="columns horizontal">
  <div class="column is-12-mobile is-7-tablet is-7-fullhd">
    <table class="table">
      <thead>
        <tr>
          <th><input type="checkbox"></th>
          <th>Name</th>
          <th *ngFor="let customColumnParentNode of customColumns" (click)="onElementSelect(customColumnParentNode.node)">
            {{customColumnParentNode.node.name}}
          </th>
          <th>Actions</th>
          <th (click)="onNewElementInit('customColumn')"><i class="ph-plus"></i>Add column</th>
        </tr>
      </thead>
      <tbody>
        <ng-container *ngTemplateOutlet="recursiveLocationsListTmpl; context:{ locationsList: elements, index: 1 }">
        </ng-container>
      </tbody>
      <button class="button is-small is-info is-light mx-1 mt-1" (click)="onNewElementInit('location')">Add Root
        Location</button>
    </table>
  </div>
  <!-- Details -->
  <div class="column is-12-mobile is-5-tablet is-4-widescreen is-offset-1-widescreen is-4-fullhd is-offset-1-fullhd">
    <div *ngIf="showDetails">
      <!-- <p>{{selectedElement | json}}</p> -->
      <div class="is-flex is-justify-content-space-between">
        <small>ID {{selectedElement.id}} {{selectedElement?.newElement}}</small>
        <button class="delete is-large" (click)="showDetails = false; selectedElement=null"></button>
      </div>
      <h2 class="is-size-3">Details</h2>
      <div class="field">
        <label class="label">Name</label>
        <div class="control">
          <input *ngIf="selectedElement.hasOwnProperty('locationName')" class="input" type="text" [(ngModel)]="selectedElement.locationName"  (focusout)="onElementUpdate()" />
          <input *ngIf="selectedElement.hasOwnProperty('productName')" class="input" type="text" [(ngModel)]="selectedElement.productName"  (focusout)="onElementUpdate()" />
          <input *ngIf="selectedElement.hasOwnProperty('name')" class="input" type="text" [(ngModel)]="selectedElement.name"  (focusout)="onElementUpdate()" />
        </div>
      </div>

      <!-- Only customColumns -->
      <ng-container *ngIf="selectedElement.hasOwnProperty('name')" >
        <!-- Data type -->
        <div class="field">
          <label class="label">Data Type</label>
          <div class="control">
            <input class="input" type="text" [(ngModel)]="selectedElement.dataType"  (focusout)="onElementUpdate()" />
          </div>
        </div>
        <!-- Allowed array -->
        <div class="field">
          <label class="label">Allowed elements</label>
          <div class="control">
            <input type="checkbox"
            [ngModel]="selectedElement.elementsAllowed.includes('locations')"
            (ngModelChange)="onCustomColumnUpdate('locations')"
            > Locations
            <input type="checkbox"
            [ngModel]="selectedElement.elementsAllowed.includes('products')"
            (ngModelChange)="onCustomColumnUpdate('products')"
            > Products
          </div>
        </div>
      </ng-container>


      <ng-container *ngIf="!selectedElement.hasOwnProperty('name')">
      <!-- Description -->
      <div class="field">
        <label class="label">Description</label>
        <div class="control">
          <textarea class="textarea has-fixed-size" [(ngModel)]="selectedElement.description" (focusout)="onElementUpdate()">
        </textarea>
        </div>
      </div>

      <!-- Custom Columns -->
      <div class="my-5">
      <h3 class="is-size-4">Custom Columns</h3>
      <div class="field" *ngFor="let customColumnParentNode of customColumns">
        <ng-container
        *ngIf="
        selectedElement.hasOwnProperty('productName') && customColumnParentNode.node.elementsAllowed.includes('products') ||
        selectedElement.hasOwnProperty('locationName') && customColumnParentNode.node.elementsAllowed.includes('locations')
      ">
        <label class="label">{{customColumnParentNode.node.name}}</label>
        <div class="control">
          <input
          class="input"
          type="text"
          [ngModel]="findCustomColumnModel(customColumnParentNode.node.id)"
          (ngModelChange)="updateCustomColumnModel(customColumnParentNode.node, $event)"
          (focusout)="onElementUpdate()"
          />
        </div>
        </ng-container>
      </div>
    </div>
    </ng-container>
    <div class="my-4">
    <!-- Actions -->
      <button *ngIf="selectedElement.hasOwnProperty('parent') || isCreatingNewElement" class="button is-primary"
        (click)="onNewElementSave()">Add new element</button>
      <button *ngIf="!isCreatingNewElement" class="button is-danger" (click)="onElementDelete()">Delete
        element</button>
    </div>
  </div>
  </div>
</div>




<!-- Templates -->

<!-- Products -->
<ng-template #productsListTmpl let-list="productsList" let-i="index">
  <!-- Products row -->
  <tr *ngFor="let parentNode of list" [ngClass]="{'is-selected': selectedElement==parentNode.node}">
    <td (click)="onElementSelect(parentNode.node)"><input type="checkbox"></td>
    <td (click)="onElementSelect(parentNode.node)">
      <p style="{{'margin-left: '+ i + 'px'}}">{{parentNode.node.productName}}</p>
    </td>
    <td *ngFor="let customColumnParentNode of customColumns">
      {{findCustomColumnValue(customColumnParentNode.node.id, parentNode.node.customColumns.edges)}}
      <!-- Find in parentNode.node.customColumns.edges (only if allowed_elements contains "products" )  -->
    </td>
    <td></td>
  </tr>
</ng-template>

<!-- Locations -->
<ng-template #recursiveLocationsListTmpl let-list="locationsList" let-i="index">
  <ng-container *ngFor="let parentNode of list">
    <ng-container *ngIf="parentNode.hasOwnProperty('node')">
      <!-- Location row -->
      <tr
        [ngClass]="{'is-selected': selectedElement==parentNode.node, 'has-background-grey-lighter': selectedElement!=parentNode.node}">
        <td (click)="onElementSelect(parentNode.node)">
          <div class="my-2"><input type="checkbox"></div>
        </td>
        <td (click)="onElementSelect(parentNode.node)">
          <p style="{{'margin-left: '+ i + 'px'}}" class="my-2">{{parentNode.node.locationName}}</p>
        </td>
        <td *ngFor="let customColumnParentNode of customColumns">
          <ng-container *ngIf="parentNode.node.hasOwnProperty('customColumns')">
            {{findCustomColumnValue(customColumnParentNode.node.id, parentNode.node.customColumns.edges)}}
            <!-- Find in parentNode.node.customColumns.edges (only if allowed_elements contains "products" )  -->
          </ng-container>
        </td>
        <td>
          <button class="button is-small is-warning is-light mx-1  mt-1"
            (click)="onNewElementInit('product', parentNode.node.id)">Add Product</button>
          <button *ngIf="i<80" class="button is-small is-info is-light mx-1 mt-1"
            (click)="onNewElementInit('location', parentNode.node.id)">Add Location</button>
        </td>
      </tr>

      <!-- Products -->
      <ng-container *ngIf="parentNode.node.hasOwnProperty('products')">
        <ng-container
          *ngTemplateOutlet="productsListTmpl; context:{ productsList: parentNode.node.products.edges, index: i+10 }">
        </ng-container>
      </ng-container>
      <!-- SubLocations -->
      <ng-container *ngIf="parentNode.node.hasOwnProperty('childrens')">
        <ng-container
          *ngTemplateOutlet="recursiveLocationsListTmpl; context:{ locationsList: parentNode.node.childrens.edges, index: i+40 }">
        </ng-container>
      </ng-container>
    </ng-container>
  </ng-container>
</ng-template>
